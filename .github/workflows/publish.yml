name: Publish to crates.io

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Publish wot-core
        run: cargo publish --manifest-path src/core/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}

      - name: Wait for wot-core to be available
        run: |
          for i in {1..30}; do
            if cargo search wot-core --limit 1 | grep -q "wot-core ="; then
              echo "wot-core published successfully"
              exit 0
            fi
            echo "Waiting for wot-core to be available on crates.io (attempt $i/30)..."
            sleep 10
          done
          echo "Timeout waiting for wot-core to be published"
          exit 1

      - name: Publish wot-nostr
        run: cargo publish --manifest-path src/nostr/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}

      - name: Publish wot-rs
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}
